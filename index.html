<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#c41e3a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="M√¢m C·ªó T·∫øt">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üßß</text></svg>">
  <link rel="manifest" href="manifest.json">
  <title>Th·ª±c ƒë∆°n T·∫øt</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
    body { background: #f5f5f5; overscroll-behavior: none; }
    .tab-active { background: #c41e3a; color: white; }
    .day-active { background: #c41e3a; color: white; }
    .day-inactive { background: white; color: #666; border: 1px solid #e0e0e0; }
    .slide-up { animation: slideUp 0.25s ease-out; }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .checkbox-done { background: #c41e3a; border-color: #c41e3a; }
    .checkbox-bought { background: #16a34a; border-color: #16a34a; }
    .line-through-custom { text-decoration: line-through; color: #999; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 16px); }
    input[type="checkbox"] { accent-color: #c41e3a; }
    ::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div id="app" class="max-w-md mx-auto bg-white min-h-screen flex flex-col"></div>
  
  <!-- Popup container - render separately to avoid flicker -->
  <div id="popup-container"></div>

  <script>
    // ==================== DATA ====================
    const dishesData = [
      // M√≥n d√πng chung (s·ªë l∆∞·ª£ng c·ªë ƒë·ªãnh, kh√¥ng nh√¢n theo ng√†y)
      { id: 'nem', name: 'Nem r√°n', note: '30 c√°i', perDay: false, source: null },
      { id: 'gio-xao', name: 'Gi√≤ x√†o', note: null, perDay: false, source: 'ƒê·ª£i ch√∫ D≈©ng' },
      { id: 'gio-be', name: 'Gi√≤ b√™', note: '1kg', perDay: false, source: null },
      { id: 'thit-dong', name: 'Th·ªãt ƒë√¥ng', note: '1kg ch√¢n gi√≤, tai, l∆∞·ª°i', perDay: false, source: null },
      { id: 'banh-chung', name: 'B√°nh ch∆∞ng / B√°nh t√©t', note: null, perDay: false, source: null },
      { id: 'bo-ngam-mam', name: 'B√≤ ng√¢m m·∫Øm', note: '2 b·∫Øp', perDay: false, source: null },
      { id: 'chan-gio-muoi', name: 'Ch√¢n gi√≤ mu·ªëi', note: '1 g√≥i', perDay: false, source: null },
      { id: 'cha-com', name: 'Ch·∫£ c·ªëm', note: '1 g√≥i', perDay: false, source: null },
      
      // M√≥n t√≠nh theo ng√†y (nh√¢n s·ªë l∆∞·ª£ng)
      { id: 'tom-hap', name: 'T√¥m h·∫•p', note: '10 con', perDay: true, source: null },
      { id: 'ca-nuong', name: 'C√° n∆∞·ªõng/chi√™n', note: '0.5kg t·∫ßm/lƒÉng/tr·∫Øm', perDay: true, source: null },
      { id: 'ga-luoc', name: 'G√† lu·ªôc', note: '2-3 con', perDay: true, source: '2 con nh√† Duy√™n' },
      { id: 'rau', name: 'Rau x√†o', note: null, perDay: true, source: 'Nh√† anh L√¢m' },
      { id: 'suon-chua-ngot', name: 'S∆∞·ªùn chua ng·ªçt', note: '1kg', perDay: true, source: null },
      { id: 'khoai-tay-thit-bo', name: 'Khoai t√¢y th·ªãt b√≤', note: '0.5kg khoai, 0.2kg b√≤', perDay: true, source: null },
      
      // ƒêƒ©a x√†o
      { id: 'xao-thap-cam', name: 'X√†o th·∫≠p c·∫©m', note: null, perDay: true, source: null },
      { id: 'xao-ngo-hat-luu', name: 'Ng√¥ h·∫°t l·ª±u', note: null, perDay: true, source: null },
      { id: 'xao-cai-chip-nam', name: 'C·∫£i ch√≠p x√†o n·∫•m', note: null, perDay: true, source: null },
      
      // Canh
      { id: 'canh-suon-khoai-so', name: 'Canh s∆∞·ªùn khoai s·ªç', note: null, perDay: true, source: null },
      { id: 'canh-suon-khoai-tay', name: 'Canh s∆∞·ªùn khoai t√¢y c√† r·ªët', note: null, perDay: true, source: null },
      { id: 'canh-xu-hao', name: 'Canh xu h√†o c√† r·ªët n·∫•m ng√¥', note: null, perDay: true, source: null },
      
      // N·ªôm/Salad
      { id: 'nom-xu-hao', name: 'N·ªôm xu h√†o c√† r·ªët', note: 'Xu h√†o, c√† r·ªët, d∆∞a chu·ªôt, b·∫Øp c·∫£i t√≠m', perDay: true, source: null },
      { id: 'salad-nga', name: 'Salad Nga', note: 'Khoai t√¢y, c√† r·ªët, d∆∞a chu·ªôt, ng√¥, ƒë·∫≠u, tr·ª©ng', perDay: true, source: null },
      { id: 'nom-ga', name: 'N·ªôm g√† x√© phay', note: 'H√†nh t√¢y, rau th∆°m, l·∫°c, b·∫Øp c·∫£i t√≠m', perDay: true, source: null },
    ];

    // Complete recipe database
    const recipes = {
      'tom-hap': {
        name: 'T√¥m h·∫•p',
        time: '20 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'T√¥m s√∫ t∆∞∆°i - 10 con (~500g)',
          'S·∫£ - 2 c√¢y (ƒë·∫≠p d·∫≠p)',
          'G·ª´ng - 1 c·ªß nh·ªè (th√°i l√°t)',
          'Bia/R∆∞·ª£u tr·∫Øng - 100ml',
          'Mu·ªëi - 1 th√¨a c√† ph√™',
          'Ti√™u - 1/2 th√¨a c√† ph√™',
          'Chanh - 2 qu·∫£',
          '·ªöt t∆∞∆°i - 2-3 qu·∫£'
        ],
        steps: [
          'T√¥m r·ª≠a s·∫°ch, c·∫Øt r√¢u ch√¢n, ƒë·ªÉ r√°o',
          'X·∫øp s·∫£ ƒë·∫≠p d·∫≠p, g·ª´ng th√°i l√°t xu·ªëng ƒë√°y n·ªìi',
          'X·∫øp t√¥m l√™n tr√™n, r·∫Øc mu·ªëi ti√™u',
          'ƒê·ªï bia/r∆∞·ª£u v√†o, ƒë·∫≠y n·∫Øp',
          'H·∫•p l·ª≠a l·ªõn 6-8 ph√∫t ƒë·∫øn khi t√¥m ƒë·ªè',
          'Pha n∆∞·ªõc ch·∫•m: chanh + mu·ªëi + ti√™u + ·ªõt bƒÉm'
        ]
      },
      'nem': {
        name: 'Nem r√°n',
        time: '1 ti·∫øng',
        servings: '30 c√°i',
        ingredients: [
          'Th·ªãt l·ª£n xay - 300g',
          'T√¥m t∆∞∆°i - 150g (b√≥c v·ªè, bƒÉm)',
          'Mi·∫øn dong - 50g (ng√¢m, c·∫Øt nh·ªè)',
          'M·ªôc nhƒ© - 30g (ng√¢m, th√°i ch·ªâ)',
          'N·∫•m h∆∞∆°ng - 5-6 c√°i (ng√¢m, th√°i nh·ªè)',
          'C√† r·ªët - 1 c·ªß nh·ªè (b√†o s·ª£i)',
          'C·ªß ƒë·∫≠u - 100g (th√°i s·ª£i)',
          'H√†nh t√¢y - 1/2 c·ªß (bƒÉm nh·ªè)',
          'Tr·ª©ng g√† - 1 qu·∫£',
          'B√°nh ƒëa nem - 30 c√°i',
          'N∆∞·ªõc m·∫Øm - 1 th√¨a canh',
          'Ti√™u - 1/2 th√¨a c√† ph√™',
          'D·∫ßu r√°n - 500ml'
        ],
        steps: [
          'Mi·∫øn, m·ªôc nhƒ©, n·∫•m h∆∞∆°ng ng√¢m n∆∞·ªõc ·∫•m, th√°i nh·ªè',
          'Tr·ªôn ƒë·ªÅu th·ªãt, t√¥m, mi·∫øn, m·ªôc nhƒ©, n·∫•m, c√† r·ªët, c·ªß ƒë·∫≠u, h√†nh',
          'Th√™m tr·ª©ng, n∆∞·ªõc m·∫Øm, ti√™u, tr·ªôn k·ªπ',
          'B√°nh ƒëa l√†m m·ªÅm b·∫±ng khƒÉn ·∫©m',
          'L·∫•y 1 th√¨a nh√¢n, cu·ªôn nem ch·∫∑t tay, g·∫•p m√©p g·ªçn',
          'R√°n d·∫ßu n√≥ng 170¬∞C, v√†ng ƒë·ªÅu 2 l·∫ßn ƒë·ªÉ gi√≤n'
        ]
      },
      'thit-dong': {
        name: 'Th·ªãt ƒë√¥ng',
        time: '3 ti·∫øng',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Ch√¢n gi√≤ l·ª£n - 500g',
          'Tai l·ª£n - 250g',
          'L∆∞·ª°i l·ª£n - 250g',
          'B√¨ l·ª£n - 200g (t·∫°o ƒë·ªô ƒë√¥ng)',
          'M·ªôc nhƒ© - 30g (ng√¢m, th√°i s·ª£i)',
          'N·∫•m h∆∞∆°ng - 20g (ng√¢m, th√°i s·ª£i)',
          'H√†nh t√≠m - 5 c·ªß',
          'N∆∞·ªõc m·∫Øm - 4 th√¨a canh',
          'Ti√™u h·∫°t - 1 th√¨a canh'
        ],
        steps: [
          'Th·ªãt ch√¢n gi√≤, tai, l∆∞·ª°i ch·∫ßn s∆°, c·∫°o r·ª≠a s·∫°ch',
          'Cho th·ªãt v√†o n·ªìi, ƒë·ªï n∆∞·ªõc ng·∫≠p, ninh nh·ªè l·ª≠a 2 ti·∫øng',
          'V·ªõt th·ªãt ra, th√°i mi·∫øng v·ª´a ƒÉn. L·ªçc n∆∞·ªõc d√πng',
          'Cho th·ªãt, m·ªôc nhƒ©, n·∫•m h∆∞∆°ng v√†o n∆∞·ªõc d√πng',
          'N√™m n∆∞·ªõc m·∫Øm, ti√™u, ninh th√™m 30 ph√∫t',
          'ƒê·ªï ra khay/b√°t, ƒë·ªÉ ngu·ªôi cho v√†o t·ªß l·∫°nh qua ƒë√™m'
        ]
      },
      'ga-luoc': {
        name: 'G√† lu·ªôc',
        time: '45 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'G√† ta - 1 con (1.2-1.5kg)',
          'Mu·ªëi h·∫°t - 2 th√¨a canh',
          'G·ª´ng - 1 c·ªß to (ƒë·∫≠p d·∫≠p)',
          'H√†nh t√≠m - 3 c·ªß',
          'L√° chanh - 5-7 l√°',
          'Rau rƒÉm - 1 b√≥',
          'Chanh - 2 qu·∫£',
          '·ªöt - 3-4 qu·∫£'
        ],
        steps: [
          'G√† l√†m s·∫°ch, ch√† mu·ªëi v√† g·ª´ng ƒë·∫≠p d·∫≠p kh·∫Øp th√¢n',
          'ƒêun n·ªìi n∆∞·ªõc l·ªõn s√¥i, cho h√†nh, g·ª´ng, l√° chanh',
          'Th·∫£ g√† v√†o, lu·ªôc l·ª≠a v·ª´a 30-35 ph√∫t',
          'T·∫Øt b·∫øp, ƒë·ªÉ g√† trong n·ªìi th√™m 10 ph√∫t',
          'V·ªõt g√† ra, nh√∫ng n∆∞·ªõc ƒë√° l·∫°nh ƒë·ªÉ da gi√≤n',
          'Ch·∫∑t mi·∫øng, pha mu·ªëi ti√™u chanh ·ªõt ƒë·ªÉ ch·∫•m'
        ]
      },
      'bo-ngam-mam': {
        name: 'B√≤ ng√¢m m·∫Øm',
        time: '1 ti·∫øng + 3 ng√†y ng√¢m',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'B·∫Øp b√≤ - 2 b·∫Øp (~1kg)',
          'N∆∞·ªõc m·∫Øm ngon - 300ml',
          'ƒê∆∞·ªùng ph√®n/ƒë∆∞·ªùng v√†ng - 100g',
          'G·ª´ng - 1 c·ªß to (th√°i l√°t)',
          'T·ªèi - 1 c·ªß (ƒë·∫≠p d·∫≠p)',
          'Hoa h·ªìi - 3 c√°nh',
          'Qu·∫ø - 1 thanh nh·ªè',
          'Ti√™u h·∫°t - 1 th√¨a canh',
          '·ªöt kh√¥ - 3-4 qu·∫£'
        ],
        steps: [
          'B·∫Øp b√≤ r·ª≠a s·∫°ch, lo·∫°i b·ªè m·ª° th·ª´a',
          'Lu·ªôc b√≤ v·ªõi g·ª´ng, hoa h·ªìi, qu·∫ø, ti√™u 40 ph√∫t',
          'V·ªõt ra ng√¢m n∆∞·ªõc ƒë√° 15 ph√∫t, th·∫•m kh√¥',
          'Pha n∆∞·ªõc ng√¢m: n∆∞·ªõc m·∫Øm + ƒë∆∞·ªùng + t·ªèi + ·ªõt, ƒëun s√¥i ƒë·ªÉ ngu·ªôi',
          'Cho b√≤ v√†o l·ªç th·ªßy tinh s·∫°ch, ƒë·ªï n∆∞·ªõc m·∫Øm ng·∫≠p',
          'ƒê·∫≠y k√≠n, ng√¢m t·ªß l·∫°nh 3-5 ng√†y. Th√°i l√°t m·ªèng khi ƒÉn'
        ]
      },
      'suon-chua-ngot': {
        name: 'S∆∞·ªùn chua ng·ªçt',
        time: '45 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'S∆∞·ªùn non - 1kg (ch·∫∑t mi·∫øng)',
          'T∆∞∆°ng c√† - 3 th√¨a canh',
          'Gi·∫•m/chanh - 2 th√¨a canh',
          'ƒê∆∞·ªùng - 3 th√¨a canh',
          'N∆∞·ªõc m·∫Øm - 2 th√¨a canh',
          'H√†nh t√≠m, t·ªèi - bƒÉm nh·ªè',
          'H√†nh t√¢y - 1 c·ªß (b·ªï m√∫i)',
          '·ªöt chu√¥ng - 1/2 qu·∫£',
          'D·ª©a (th∆°m) - 1/4 qu·∫£',
          'B·ªôt nƒÉng - 1 th√¨a canh'
        ],
        steps: [
          'S∆∞·ªùn ch·∫∑t mi·∫øng, ch·∫ßn qua n∆∞·ªõc s√¥i, r·ª≠a s·∫°ch',
          '∆Ø·ªõp s∆∞·ªùn v·ªõi 1 th√¨a n∆∞·ªõc m·∫Øm, ti√™u 15 ph√∫t',
          'Chi√™n s∆∞·ªùn v√†ng gi√≤n, v·ªõt ra',
          'Pha s·ªët: t∆∞∆°ng c√† + gi·∫•m + ƒë∆∞·ªùng + n∆∞·ªõc m·∫Øm + ch√∫t n∆∞·ªõc',
          'Phi t·ªèi, cho s·ªët v√†o ƒëun s√¥i, th√™m s∆∞·ªùn rim 10 ph√∫t',
          'Cho d·ª©a, h√†nh t√¢y, ·ªõt chu√¥ng v√†o ƒë·∫£o nhanh',
          'R∆∞·ªõi b·ªôt nƒÉng pha n∆∞·ªõc ƒë·ªÉ s·ªët s√°nh'
        ]
      },
      'canh-suon-khoai-so': {
        name: 'Canh s∆∞·ªùn khoai s·ªç',
        time: '1 ti·∫øng',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'S∆∞·ªùn non - 400g (ch·∫∑t mi·∫øng)',
          'Khoai s·ªç - 400g (g·ªçt v·ªè)',
          'H√†nh t√≠m - 3 c·ªß',
          'N∆∞·ªõc m·∫Øm - 2 th√¨a canh',
          'H·∫°t n√™m - 1 th√¨a c√† ph√™',
          'H√†nh l√° - 2 c√¢y',
          'Rau m√πi - 1 b√≥ nh·ªè',
          'Ti√™u - 1/2 th√¨a c√† ph√™'
        ],
        steps: [
          'S∆∞·ªùn ch·∫∑t mi·∫øng, ch·∫ßn qua n∆∞·ªõc s√¥i, r·ª≠a s·∫°ch',
          'Khoai s·ªç g·ªçt v·ªè, ng√¢m n∆∞·ªõc mu·ªëi tr√°nh ng·ª©a',
          'Phi h√†nh th∆°m, cho s∆∞·ªùn v√†o x√†o sƒÉn',
          'ƒê·ªï n∆∞·ªõc ng·∫≠p, ninh nh·ªè l·ª≠a 30 ph√∫t',
          'Cho khoai s·ªç v√†o, n·∫•u th√™m 15 ph√∫t',
          'N√™m n∆∞·ªõc m·∫Øm, h·∫°t n√™m. R·∫Øc h√†nh, rau m√πi, ti√™u'
        ]
      },
      'canh-suon-khoai-tay': {
        name: 'Canh s∆∞·ªùn khoai t√¢y c√† r·ªët',
        time: '50 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'S∆∞·ªùn non - 400g',
          'Khoai t√¢y - 300g',
          'C√† r·ªët - 2 c·ªß',
          'H√†nh t√¢y - 1 c·ªß',
          'G·ª´ng - 1 c·ªß nh·ªè',
          'N∆∞·ªõc m·∫Øm - 2 th√¨a canh',
          'Mu·ªëi, ti√™u, h√†nh l√°'
        ],
        steps: [
          'S∆∞·ªùn ch·∫ßn s∆°, r·ª≠a s·∫°ch b·ªçt',
          'Cho s∆∞·ªùn v√†o n·ªìi n∆∞·ªõc l·∫°nh c√πng g·ª´ng ƒë·∫≠p',
          'ƒêun s√¥i, h·∫° l·ª≠a nh·ªè ninh 25 ph√∫t',
          'Th√™m khoai t√¢y, c√† r·ªët, h√†nh t√¢y c·∫Øt mi·∫øng',
          'N·∫•u th√™m 15 ph√∫t ƒë·∫øn khi rau c·ªß m·ªÅm',
          'N√™m n∆∞·ªõc m·∫Øm, mu·ªëi, ti√™u. R·∫Øc h√†nh l√°'
        ]
      },
      'canh-xu-hao': {
        name: 'Canh xu h√†o c√† r·ªët n·∫•m ng√¥',
        time: '30 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Xu h√†o - 1 c·ªß to',
          'C√† r·ªët - 1 c·ªß',
          'Ng√¥ ng·ªçt - 1 b·∫Øp (c·∫Øt kh√∫c)',
          'N·∫•m r∆°m/n·∫•m h∆∞∆°ng - 100g',
          'Th·ªãt b·∫±m - 150g (vi√™n nh·ªè)',
          'H√†nh l√° - 2 c√¢y',
          'N∆∞·ªõc m·∫Øm - 1.5 th√¨a canh',
          'H·∫°t n√™m - 1 th√¨a c√† ph√™'
        ],
        steps: [
          'Xu h√†o, c√† r·ªët g·ªçt v·ªè, th√°i mi·∫øng',
          'Th·ªãt b·∫±m vi√™n nh·ªè, ch·∫ßn qua n∆∞·ªõc s√¥i',
          'ƒêun s√¥i n·ªìi n∆∞·ªõc, cho ng√¥ v√†o tr∆∞·ªõc 10 ph√∫t',
          'Th√™m xu h√†o, c√† r·ªët, n·∫•m, vi√™n th·ªãt',
          'N·∫•u 10 ph√∫t, n√™m n∆∞·ªõc m·∫Øm, h·∫°t n√™m',
          'T·∫Øt b·∫øp, r·∫Øc h√†nh l√° th√°i nh·ªè'
        ]
      },
      'nom-xu-hao': {
        name: 'N·ªôm xu h√†o c√† r·ªët',
        time: '25 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Xu h√†o - 1 c·ªß (b√†o s·ª£i)',
          'C√† r·ªët - 1 c·ªß (b√†o s·ª£i)',
          'D∆∞a chu·ªôt - 1 qu·∫£ (th√°i s·ª£i)',
          'B·∫Øp c·∫£i t√≠m - 100g (th√°i s·ª£i)',
          'Rau rƒÉm - 1 b√≥',
          'L·∫°c rang - 50g (gi√£ d·∫≠p)',
          'Gi·∫•m - 3 th√¨a canh',
          'ƒê∆∞·ªùng - 2 th√¨a canh',
          'N∆∞·ªõc m·∫Øm - 2 th√¨a canh',
          'T·ªèi, ·ªõt - bƒÉm nh·ªè'
        ],
        steps: [
          'Xu h√†o, c√† r·ªët b√†o s·ª£i, ng√¢m n∆∞·ªõc ƒë√° cho gi√≤n',
          'D∆∞a chu·ªôt, b·∫Øp c·∫£i th√°i s·ª£i m·ªèng',
          'Pha n∆∞·ªõc tr·ªôn: gi·∫•m + ƒë∆∞·ªùng + n∆∞·ªõc m·∫Øm + t·ªèi ·ªõt',
          'V·∫Øt r√°o rau c·ªß, cho v√†o t√¥ l·ªõn',
          'Tr·ªôn ƒë·ªÅu v·ªõi n∆∞·ªõc s·ªët, ƒë·ªÉ ng·∫•m 10 ph√∫t',
          'R·∫Øc rau rƒÉm, l·∫°c rang. D√πng ngay ƒë·ªÉ gi·ªØ gi√≤n'
        ]
      },
      'salad-nga': {
        name: 'Salad Nga',
        time: '40 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Khoai t√¢y - 300g (lu·ªôc, c·∫Øt h·∫°t l·ª±u)',
          'C√† r·ªët - 2 c·ªß (lu·ªôc, c·∫Øt h·∫°t l·ª±u)',
          'D∆∞a chu·ªôt - 1 qu·∫£ (c·∫Øt h·∫°t l·ª±u)',
          'Ng√¥ ng·ªçt - 100g (lu·ªôc)',
          'ƒê·∫≠u H√† Lan - 100g (lu·ªôc)',
          'Tr·ª©ng g√† - 3 qu·∫£ (lu·ªôc, c·∫Øt nh·ªè)',
          'X√∫c x√≠ch/giƒÉm b√¥ng - 100g (c·∫Øt h·∫°t l·ª±u)',
          'Mayonnaise - 150g',
          'S·ªØa chua kh√¥ng ƒë∆∞·ªùng - 50g',
          'Mu·ªëi, ti√™u - v·ª´a ƒë·ªß'
        ],
        steps: [
          'Khoai t√¢y, c√† r·ªët lu·ªôc ch√≠n, ƒë·ªÉ ngu·ªôi, c·∫Øt h·∫°t l·ª±u',
          'Tr·ª©ng lu·ªôc ch√≠n, b√≥c v·ªè, c·∫Øt nh·ªè',
          'D∆∞a chu·ªôt c·∫Øt h·∫°t l·ª±u, r·∫Øc mu·ªëi, v·∫Øt r√°o',
          'Tr·ªôn mayonnaise v·ªõi s·ªØa chua, mu·ªëi, ti√™u',
          'Cho t·∫•t c·∫£ nguy√™n li·ªáu v√†o t√¥, tr·ªôn ƒë·ªÅu v·ªõi s·ªët',
          'ƒê·ªÉ t·ªß l·∫°nh 30 ph√∫t, d√πng l·∫°nh'
        ]
      },
      'nom-ga': {
        name: 'N·ªôm g√† x√© phay',
        time: '45 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          '·ª®c g√†/ƒë√πi g√† - 400g (lu·ªôc, x√© s·ª£i)',
          'H√†nh t√¢y - 1 c·ªß (th√°i m·ªèng)',
          'B·∫Øp c·∫£i t√≠m - 150g (th√°i s·ª£i)',
          'Rau th∆°m (h√∫ng, m√πi) - 1 b√≥',
          'L·∫°c rang - 50g (gi√£ d·∫≠p)',
          'H√†nh phi - 30g',
          'Chanh - 2 qu·∫£',
          'N∆∞·ªõc m·∫Øm - 3 th√¨a canh',
          'ƒê∆∞·ªùng - 2 th√¨a canh',
          'T·ªèi, ·ªõt - bƒÉm nh·ªè'
        ],
        steps: [
          'G√† lu·ªôc ch√≠n, ƒë·ªÉ ngu·ªôi, x√© s·ª£i nh·ªè',
          'H√†nh t√¢y th√°i m·ªèng, ng√¢m n∆∞·ªõc ƒë√° b·ªõt hƒÉng',
          'B·∫Øp c·∫£i th√°i s·ª£i, ng√¢m n∆∞·ªõc ƒë√° cho gi√≤n',
          'Pha n∆∞·ªõc tr·ªôn: n∆∞·ªõc c·ªët chanh + m·∫Øm + ƒë∆∞·ªùng + t·ªèi ·ªõt',
          'Tr·ªôn g√† v·ªõi h√†nh t√¢y, b·∫Øp c·∫£i',
          'Cho n∆∞·ªõc tr·ªôn v√†o ƒë·∫£o ƒë·ªÅu',
          'R·∫Øc rau th∆°m, l·∫°c, h√†nh phi l√™n tr√™n'
        ]
      },
      'xao-thap-cam': {
        name: 'X√†o th·∫≠p c·∫©m',
        time: '30 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Th·ªãt b√≤/l·ª£n - 200g (th√°i l√°t)',
          'T√¥m - 150g (b√≥c v·ªè)',
          'M·ª±c - 150g (c·∫Øt khoanh)',
          'C√† r·ªët - 1 c·ªß (th√°i hoa)',
          'Ng√¥ bao t·ª≠ - 100g',
          'S√∫p l∆° - 200g',
          'ƒê·∫≠u H√† Lan - 50g',
          'N·∫•m h∆∞∆°ng - 5-6 c√°i',
          'T·ªèi - 4 t√©p (bƒÉm)',
          'D·∫ßu h√†o - 2 th√¨a canh',
          'Mu·ªëi, ti√™u'
        ],
        steps: [
          'Rau c·ªß r·ª≠a s·∫°ch, c·∫Øt mi·∫øng, ch·∫ßn s∆°',
          'T√¥m, m·ª±c ∆∞·ªõp ch√∫t mu·ªëi ti√™u',
          'Phi t·ªèi, x√†o th·ªãt ch√≠n t·ªõi, ƒë·ªï ra',
          'X√†o t√¥m m·ª±c ri√™ng, ƒë·ªï ra',
          'X√†o rau c·ªß l·ª≠a l·ªõn, th√™m d·∫ßu h√†o',
          'Cho th·ªãt, t√¥m m·ª±c v√†o, ƒë·∫£o ƒë·ªÅu, n√™m v·ª´a'
        ]
      },
      'xao-ngo-hat-luu': {
        name: 'Ng√¥ h·∫°t l·ª±u x√†o t√¥m',
        time: '30 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Ng√¥ ng·ªçt - 2 b·∫Øp (t√°ch h·∫°t)',
          'T√¥m t∆∞∆°i - 200g (b√≥c v·ªè)',
          'C√† r·ªët - 1 c·ªß (th√°i h·∫°t l·ª±u)',
          'ƒê·∫≠u H√† Lan - 100g',
          'H√†nh t√¢y - 1/2 c·ªß (th√°i h·∫°t l·ª±u)',
          'T·ªèi - 3 t√©p (bƒÉm)',
          'D·∫ßu h√†o - 1 th√¨a canh',
          'Mu·ªëi, ti√™u, ƒë∆∞·ªùng'
        ],
        steps: [
          'T√¥m b√≥c v·ªè, ∆∞·ªõp ch√∫t mu·ªëi ti√™u',
          'C√† r·ªët, h√†nh t√¢y th√°i h·∫°t l·ª±u nh·ªè ƒë·ªÅu',
          'Ch·∫ßn ng√¥, c√† r·ªët, ƒë·∫≠u qua n∆∞·ªõc s√¥i',
          'Phi t·ªèi, x√†o t√¥m ch√≠n h·ªìng, ƒë·ªï ra',
          'X√†o ng√¥, c√† r·ªët, ƒë·∫≠u, h√†nh v·ªõi d·∫ßu h√†o',
          'Cho t√¥m v√†o, n√™m gia v·ªã, ƒë·∫£o nhanh'
        ]
      },
      'xao-cai-chip-nam': {
        name: 'C·∫£i ch√≠p x√†o n·∫•m',
        time: '15 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'C·∫£i ch√≠p - 500g',
          'N·∫•m h∆∞∆°ng - 100g',
          'N·∫•m kim ch√¢m - 100g',
          'T·ªèi - 6 t√©p (bƒÉm)',
          'D·∫ßu h√†o - 2 th√¨a canh',
          'D·∫ßu ƒÉn - 3 th√¨a canh',
          'Mu·ªëi, ƒë∆∞·ªùng',
          'B·ªôt nƒÉng - 1 th√¨a (pha lo√£ng)'
        ],
        steps: [
          'C·∫£i ch√≠p b·ªï d·ªçc, r·ª≠a s·∫°ch, ƒë·ªÉ r√°o',
          'N·∫•m h∆∞∆°ng th√°i l√°t, n·∫•m kim ch√¢m c·∫Øt g·ªëc',
          'Ch·∫ßn c·∫£i qua n∆∞·ªõc s√¥i c√≥ ch√∫t mu·ªëi, d·∫ßu',
          'Phi t·ªèi th∆°m, x√†o n·∫•m v·ªõi d·∫ßu h√†o',
          'X·∫øp c·∫£i ra ƒëƒ©a, chan n·∫•m x√†o l√™n tr√™n',
          'R∆∞·ªõi ch√∫t b·ªôt nƒÉng pha lo√£ng ƒë·ªÉ s√°nh'
        ]
      },
      'ca-nuong': {
        name: 'C√° n∆∞·ªõng/chi√™n',
        time: '40 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'C√° (t·∫ßm/lƒÉng/tr·∫Øm) - 0.5kg',
          'H√†nh t√≠m - 3 c·ªß (bƒÉm)',
          'T·ªèi - 5 t√©p (bƒÉm)',
          'S·∫£ - 2 c√¢y (bƒÉm)',
          'Ngh·ªá t∆∞∆°i/b·ªôt - 1 c·ªß nh·ªè',
          'N∆∞·ªõc m·∫Øm - 2 th√¨a canh',
          'D·∫ßu ƒÉn - 3 th√¨a canh',
          'Ti√™u, ƒë∆∞·ªùng',
          'Th√¨ l√†/h√†nh l√° - 1 b√≥'
        ],
        steps: [
          'C√° l√†m s·∫°ch, kh·ª©a v√†i ƒë∆∞·ªùng tr√™n th√¢n',
          'Tr·ªôn h√†nh, t·ªèi, s·∫£, ngh·ªá, n∆∞·ªõc m·∫Øm, ti√™u, ƒë∆∞·ªùng',
          '∆Ø·ªõp c√° v·ªõi gia v·ªã 15-20 ph√∫t',
          'N∆∞·ªõng: l√≤ 200¬∞C trong 20-25 ph√∫t, l·∫≠t ƒë·ªÅu',
          'Ho·∫∑c chi√™n: d·∫ßu n√≥ng gi√†, chi√™n v√†ng ƒë·ªÅu 2 m·∫∑t',
          'R·∫Øc th√¨ l√†/h√†nh l√° trang tr√≠'
        ]
      },
      'khoai-tay-thit-bo': {
        name: 'Khoai t√¢y x√†o th·ªãt b√≤',
        time: '40 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Th·ªãt b√≤ - 200g (th√°i mi·∫øng)',
          'Khoai t√¢y - 500g (c·∫Øt mi·∫øng)',
          'C√† r·ªët - 1 c·ªß',
          'H√†nh t√¢y - 1 c·ªß (b·ªï m√∫i)',
          'T·ªèi - 4 t√©p (bƒÉm)',
          'N∆∞·ªõc t∆∞∆°ng - 2 th√¨a canh',
          'D·∫ßu h√†o - 1 th√¨a canh',
          'Ti√™u - 1/2 th√¨a c√† ph√™',
          'D·∫ßu ƒÉn - 3 th√¨a canh'
        ],
        steps: [
          'B√≤ th√°i mi·∫øng, ∆∞·ªõp n∆∞·ªõc t∆∞∆°ng, ti√™u, t·ªèi',
          'Khoai t√¢y, c√† r·ªët g·ªçt v·ªè, c·∫Øt mi·∫øng vu√¥ng',
          'X√†o b√≤ l·ª≠a l·ªõn ch√≠n t√°i, ƒë·ªï ra',
          'X√†o khoai t√¢y, c√† r·ªët cho h∆°i v√†ng',
          'Th√™m n∆∞·ªõc x√¢m x·∫•p, ninh 20 ph√∫t',
          'Cho b√≤, h√†nh t√¢y, d·∫ßu h√†o v√†o rim ƒë·∫øn c·∫°n'
        ]
      },
      'rau': {
        name: 'Rau x√†o t·ªèi',
        time: '10 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Rau c·∫£i/rau mu·ªëng - 500g',
          'T·ªèi - 4 t√©p (bƒÉm)',
          'D·∫ßu ƒÉn - 2 th√¨a canh',
          'N∆∞·ªõc m·∫Øm - 1 th√¨a canh',
          'H·∫°t n√™m - 1/2 th√¨a c√† ph√™'
        ],
        steps: [
          'Rau nh·∫∑t s·∫°ch, r·ª≠a k·ªπ, ƒë·ªÉ r√°o',
          'Phi t·ªèi th∆°m v·ªõi d·∫ßu ƒÉn',
          'Cho rau v√†o x√†o l·ª≠a l·ªõn, ƒë·∫£o nhanh',
          'N√™m n∆∞·ªõc m·∫Øm, h·∫°t n√™m v·ª´a ƒÉn',
          'X√†o 2-3 ph√∫t ƒë·∫øn khi rau v·ª´a ch√≠n t·ªõi'
        ]
      },
      'gio-xao': {
        name: 'Gi√≤ x√†o',
        time: '1.5 ti·∫øng',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Th·ªãt ba ch·ªâ - 500g',
          'M·ªôc nhƒ© - 50g (ng√¢m, th√°i s·ª£i)',
          'N·∫•m h∆∞∆°ng - 30g (ng√¢m, th√°i s·ª£i)',
          'Tr·ª©ng g√† - 5 qu·∫£',
          'H√†nh kh√¥ - 5 c·ªß (phi v√†ng)',
          'N∆∞·ªõc m·∫Øm - 3 th√¨a canh',
          'Ti√™u - 1 th√¨a c√† ph√™',
          'L√° chu·ªëi - 3-4 l√° (h∆° m·ªÅm)'
        ],
        steps: [
          'Th·ªãt ba ch·ªâ th√°i mi·∫øng m·ªèng, ∆∞·ªõp n∆∞·ªõc m·∫Øm, ti√™u',
          'X√†o th·ªãt ch√≠n t·ªõi, th√™m m·ªôc nhƒ©, n·∫•m h∆∞∆°ng',
          'Tr·ª©ng ƒë√°nh tan, ƒë·ªï v√†o tr·ªôn ƒë·ªÅu v·ªõi th·ªãt',
          'Th√™m h√†nh phi, ƒë·∫£o l·ª≠a nh·ªè ƒë·∫øn khi tr·ª©ng se',
          'L√° chu·ªëi h∆° m·ªÅm, l√≥t khu√¥n ho·∫∑c g√≥i h√¨nh tr·ª•',
          'Cho h·ªón h·ª£p v√†o n√©n ch·∫∑t, h·∫•p 45-60 ph√∫t'
        ]
      },
      'gio-be': {
        name: 'Gi√≤ b√™',
        time: '10 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Gi√≤ b√™ - 1kg (mua s·∫µn)',
          'D∆∞a g√≥p - 200g',
          'Rau m√πi - 1 b√≥ nh·ªè'
        ],
        steps: [
          'Gi√≤ b√™ ƒë·ªÉ t·ªß l·∫°nh ƒë·∫øn khi d√πng',
          'L·∫•y ra 15 ph√∫t tr∆∞·ªõc ƒë·ªÉ b·ªõt l·∫°nh',
          'Th√°i l√°t v·ª´a ƒÉn, kho·∫£ng 0.5cm',
          'B√†y ƒëƒ©a, trang tr√≠ v·ªõi rau m√πi',
          'ƒÇn k√®m d∆∞a g√≥p, n∆∞·ªõc m·∫Øm chua ng·ªçt'
        ]
      },
      'chan-gio-muoi': {
        name: 'Ch√¢n gi√≤ mu·ªëi',
        time: '10 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Ch√¢n gi√≤ mu·ªëi - 1 g√≥i (~500g)',
          'D∆∞a g√≥p - 200g',
          'Rau m√πi/th√¨ l√† - 1 b√≥ nh·ªè'
        ],
        steps: [
          'Ch√¢n gi√≤ l·∫•y ra, ƒë·ªÉ nhi·ªát ƒë·ªô ph√≤ng 10 ph√∫t',
          'Th√°i l√°t m·ªèng v·ª´a ƒÉn, kho·∫£ng 3-4mm',
          'X·∫øp ƒëƒ©a h√¨nh tr√≤n ho·∫∑c h√¨nh qu·∫°t',
          'Trang tr√≠ v·ªõi rau m√πi, th√¨ l√†',
          'ƒÇn k√®m d∆∞a g√≥p ƒë·ªÉ c√¢n b·∫±ng v·ªã m·∫∑n'
        ]
      },
      'cha-com': {
        name: 'Ch·∫£ c·ªëm',
        time: '10 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'Ch·∫£ c·ªëm - 1 g√≥i (~300-400g)',
          'Rau m√πi - 1 b√≥ nh·ªè',
          'N∆∞·ªõc m·∫Øm chua ng·ªçt - 50ml'
        ],
        steps: [
          'Ch·∫£ c·ªëm ƒë·ªÉ nguy√™n trong g√≥i, b·∫£o qu·∫£n t·ªß l·∫°nh',
          'Tr∆∞·ªõc khi ƒÉn, l·∫•y ra ƒë·ªÉ 10 ph√∫t',
          'Th√°i l√°t v·ª´a ƒÉn, kho·∫£ng 5-7mm',
          'X·∫øp ƒëƒ©a, trang tr√≠ v·ªõi rau m√πi',
          'ƒÇn k√®m n∆∞·ªõc m·∫Øm chua ng·ªçt ho·∫∑c t∆∞∆°ng ·ªõt'
        ]
      },
      'banh-chung': {
        name: 'B√°nh ch∆∞ng / B√°nh t√©t',
        time: '15 ph√∫t',
        servings: '4-6 ng∆∞·ªùi',
        ingredients: [
          'B√°nh ch∆∞ng/t√©t - 1-2 c√°i',
          'D∆∞a h√†nh - 200g',
          'N∆∞·ªõc m·∫Øm - 50ml'
        ],
        steps: [
          'B√°nh ngu·ªôi: h·∫•p l·∫°i 10-15 ph√∫t cho n√≥ng m·ªÅm',
          'Ho·∫∑c: c·∫Øt l√°t, chi√™n v√†ng 2 m·∫∑t v·ªõi ch√∫t d·∫ßu',
          'B√≥c l√°, c·∫Øt mi·∫øng vu√¥ng v·ª´a ƒÉn',
          'B√†y ƒëƒ©a, ƒÉn k√®m d∆∞a h√†nh mu·ªëi',
          'Ch·∫•m n∆∞·ªõc m·∫Øm ho·∫∑c ƒÉn kh√¥ng'
        ]
      }
    };

    // ==================== STATE ====================
    let state = {
      activeMainTab: 'menu',
      activeDay: 1,
      days: { 1: {}, 2: {}, 3: {} },
      shoppingChecked: {}, // { dishId: true/false }
      showAddPopup: false,
      showRecipe: null,
      addPopupSelections: {}
    };

    // ==================== STORAGE ====================
    function loadState() {
      try {
        const saved = localStorage.getItem('tet-menu-v3');
        if (saved) {
          const parsed = JSON.parse(saved);
          state.days = parsed.days || { 1: {}, 2: {}, 3: {} };
          state.shoppingChecked = parsed.shoppingChecked || {};
        }
      } catch (e) { console.error('Load error:', e); }
    }

    function saveState() {
      try {
        localStorage.setItem('tet-menu-v3', JSON.stringify({
          days: state.days,
          shoppingChecked: state.shoppingChecked
        }));
      } catch (e) { console.error('Save error:', e); }
    }

    // ==================== HELPERS ====================
    function getDishById(id) {
      return dishesData.find(d => d.id === id);
    }

    function getDishesForDay(day) {
      return Object.keys(state.days[day]).map(id => ({
        ...getDishById(id),
        done: state.days[day][id].done
      })).filter(d => d && d.id);
    }

    function countDone(day) {
      return getDishesForDay(day).filter(d => d.done).length;
    }

    function countTotal(day) {
      return Object.keys(state.days[day]).length;
    }

    function getAvailableDishes() {
      const currentDayDishes = Object.keys(state.days[state.activeDay]);
      return dishesData.filter(d => !currentDayDishes.includes(d.id));
    }

    function generateShoppingList() {
      const items = [];
      dishesData.forEach(dish => {
        let dayCount = 0;
        [1, 2, 3].forEach(day => {
          if (state.days[day][dish.id]) dayCount++;
        });
        if (dayCount === 0) return;
        
        items.push({
          id: dish.id,
          name: dish.name,
          note: dish.note,
          source: dish.source,
          days: dayCount,
          multiplier: dish.perDay ? dayCount : 1,
          perDay: dish.perDay,
          checked: state.shoppingChecked[dish.id] || false
        });
      });
      return items;
    }

    // ==================== ACTIONS ====================
    function setMainTab(tab) {
      state.activeMainTab = tab;
      renderMain();
    }

    function setActiveDay(day) {
      state.activeDay = day;
      renderMain();
    }

    function toggleDone(dishId) {
      if (state.days[state.activeDay][dishId]) {
        state.days[state.activeDay][dishId].done = !state.days[state.activeDay][dishId].done;
        saveState();
        renderMain();
      }
    }

    function removeDish(dishId) {
      delete state.days[state.activeDay][dishId];
      // Also remove from shopping checked if no longer in any day
      let stillExists = false;
      [1, 2, 3].forEach(day => {
        if (state.days[day][dishId]) stillExists = true;
      });
      if (!stillExists) delete state.shoppingChecked[dishId];
      saveState();
      renderMain();
    }

    function toggleShoppingItem(dishId) {
      state.shoppingChecked[dishId] = !state.shoppingChecked[dishId];
      saveState();
      renderMain();
    }

    function openAddPopup() {
      state.showAddPopup = true;
      state.addPopupSelections = {};
      renderPopup();
    }

    function closeAddPopup() {
      state.showAddPopup = false;
      renderPopup();
    }

    function toggleAddSelection(dishId) {
      state.addPopupSelections[dishId] = !state.addPopupSelections[dishId];
      // Only update the checkbox, not re-render entire popup
      const checkbox = document.getElementById('cb-' + dishId);
      const label = document.getElementById('label-' + dishId);
      if (checkbox && label) {
        checkbox.checked = state.addPopupSelections[dishId];
        label.className = state.addPopupSelections[dishId] 
          ? 'flex items-center gap-3 p-3 rounded-xl cursor-pointer bg-red-50 border-2 border-[#c41e3a]'
          : 'flex items-center gap-3 p-3 rounded-xl cursor-pointer bg-gray-50 border-2 border-transparent';
      }
      // Update button
      updateAddButton();
    }

    function updateAddButton() {
      const count = Object.values(state.addPopupSelections).filter(Boolean).length;
      const btn = document.getElementById('add-confirm-btn');
      if (btn) {
        btn.disabled = count === 0;
        btn.textContent = count > 0 ? `Th√™m ${count} m√≥n ƒë√£ ch·ªçn` : 'Ch·ªçn m√≥n ƒë·ªÉ th√™m';
      }
    }

    function confirmAddDishes() {
      Object.keys(state.addPopupSelections).forEach(dishId => {
        if (state.addPopupSelections[dishId]) {
          state.days[state.activeDay][dishId] = { done: false };
        }
      });
      saveState();
      state.showAddPopup = false;
      renderPopup();
      renderMain();
    }

    function openRecipe(dishId) {
      state.showRecipe = dishId;
      renderPopup();
    }

    function closeRecipe() {
      state.showRecipe = null;
      renderPopup();
    }

    // ==================== RENDER ====================
    function renderMain() {
      const app = document.getElementById('app');
      const shoppingList = generateShoppingList();
      const shoppingCount = shoppingList.length;
      const boughtCount = shoppingList.filter(i => i.checked).length;
      
      app.innerHTML = `
        <!-- Header -->
        <header class="px-4 pt-6 pb-4">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üßß</span>
            <div>
              <h1 class="text-2xl font-bold text-gray-900">Th·ª±c ƒë∆°n T·∫øt</h1>
              <p class="text-sm text-gray-500">Qu·∫£n l√Ω m√≥n ƒÉn 3 ng√†y T·∫øt</p>
            </div>
          </div>
        </header>

        <!-- Main Tabs -->
        <div class="px-4 pb-3">
          <div class="flex gap-2">
            <button onclick="setMainTab('menu')" 
              class="flex-1 py-3 rounded-xl font-medium text-sm flex items-center justify-center gap-2 transition-all
                     ${state.activeMainTab === 'menu' ? 'tab-active' : 'bg-gray-100 text-gray-600'}">
              <i data-lucide="utensils" class="w-4 h-4"></i> Th·ª±c ƒë∆°n
            </button>
            <button onclick="setMainTab('shopping')" 
              class="flex-1 py-3 rounded-xl font-medium text-sm flex items-center justify-center gap-2 transition-all
                     ${state.activeMainTab === 'shopping' ? 'tab-active' : 'bg-gray-100 text-gray-600'}">
              <i data-lucide="shopping-cart" class="w-4 h-4"></i> ƒêi ch·ª£
              ${shoppingCount > 0 ? `<span class="${state.activeMainTab === 'shopping' ? 'bg-white/20' : 'bg-[#c41e3a] text-white'} px-2 py-0.5 rounded-full text-xs">${boughtCount}/${shoppingCount}</span>` : ''}
            </button>
          </div>
        </div>

        ${state.activeMainTab === 'menu' ? renderMenuTab() : renderShoppingTab()}
      `;
      lucide.createIcons();
    }

    function renderMenuTab() {
      const dishes = getDishesForDay(state.activeDay);
      
      return `
        <!-- Day Tabs -->
        <div class="px-4 pb-4">
          <div class="flex gap-2">
            ${[1, 2, 3].map(day => `
              <button onclick="setActiveDay(${day})"
                class="flex-1 py-3 rounded-xl text-center transition-all
                       ${state.activeDay === day ? 'day-active' : 'day-inactive'}">
                <div class="font-semibold text-sm">M√πng ${day}</div>
                <div class="text-xs mt-0.5 opacity-80">${countDone(day)}/${countTotal(day)} ‚úì</div>
              </button>
            `).join('')}
          </div>
        </div>

        <!-- Dishes List -->
        <div class="flex-1 overflow-auto px-4 pb-24">
          ${dishes.length === 0 ? `
            <div class="text-center py-16 text-gray-400">
              <div class="mb-4 flex justify-center"><i data-lucide="utensils" class="w-12 h-12 text-gray-300"></i></div>
              <p class="font-medium">Ch∆∞a c√≥ m√≥n n√†o</p>
              <p class="text-sm mt-1">B·∫•m n√∫t b√™n d∆∞·ªõi ƒë·ªÉ th√™m m√≥n</p>
            </div>
          ` : `
            <div class="space-y-2">
              ${dishes.map(dish => renderDishItem(dish)).join('')}
            </div>
          `}
        </div>

        <!-- Add Button -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent safe-bottom">
          <div class="max-w-md mx-auto">
            <button onclick="openAddPopup()"
              class="w-full py-3.5 bg-[#c41e3a] text-white rounded-xl font-medium text-sm
                     active:scale-[0.98] transition-all shadow-lg shadow-red-200">
              <i data-lucide="plus" class="w-5 h-5"></i> Th√™m m√≥n v√†o M√πng ${state.activeDay}
            </button>
          </div>
        </div>
      `;
    }

    function renderDishItem(dish) {
      const hasRecipe = recipes[dish.id];
      return `
        <div class="bg-gray-50 rounded-xl p-4 flex items-center gap-3 ${dish.done ? 'opacity-60' : ''}">
          <button onclick="toggleDone('${dish.id}')"
            class="w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition-all
                   ${dish.done ? 'checkbox-done' : 'border-gray-300'}">
            ${dish.done ? '<svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>' : ''}
          </button>
          
          <div class="flex-1 min-w-0" onclick="${hasRecipe ? `openRecipe('${dish.id}')` : ''}">
            <div class="font-medium text-gray-900 ${dish.done ? 'line-through-custom' : ''}">${dish.name}</div>
            ${dish.note || dish.source ? `
              <div class="text-xs text-gray-500 mt-0.5 truncate">
                ${dish.note || ''}${dish.note && dish.source ? ' ‚Ä¢ ' : ''}${dish.source ? `<i data-lucide="map-pin" class="w-3 h-3 inline-block align-text-bottom"></i> ${dish.source}` : ''}
              </div>
            ` : ''}
          </div>
          
          <div class="flex items-center gap-1">
            ${hasRecipe ? `
              <button onclick="event.stopPropagation(); openRecipe('${dish.id}')"
                class="w-9 h-9 rounded-full flex items-center justify-center text-gray-400 hover:bg-white transition-all">
                <i data-lucide="book-open" class="w-4 h-4"></i>
              </button>
            ` : ''}
            <button onclick="event.stopPropagation(); removeDish('${dish.id}')"
              class="w-9 h-9 rounded-full flex items-center justify-center text-gray-300 hover:bg-red-50 hover:text-red-500 transition-all">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      `;
    }

    function renderShoppingTab() {
      const items = generateShoppingList();
      const boughtCount = items.filter(i => i.checked).length;
      const progress = items.length > 0 ? (boughtCount / items.length) * 100 : 0;
      
      return `
        <div class="flex-1 overflow-auto px-4 pb-8">
          ${items.length === 0 ? `
            <div class="text-center py-16 text-gray-400">
              <div class="mb-4 flex justify-center"><i data-lucide="shopping-cart" class="w-12 h-12 text-gray-300"></i></div>
              <p class="font-medium">Ch∆∞a c√≥ g√¨ c·∫ßn mua</p>
              <p class="text-sm mt-1">Th√™m m√≥n v√†o th·ª±c ƒë∆°n tr∆∞·ªõc nh√©</p>
            </div>
          ` : `
            <!-- Progress -->
            <div class="mb-4 p-4 bg-green-50 rounded-xl">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-green-800">Ti·∫øn ƒë·ªô mua s·∫Øm</span>
                <span class="text-sm text-green-600">${boughtCount}/${items.length}</span>
              </div>
              <div class="h-2 bg-green-200 rounded-full overflow-hidden">
                <div class="h-full bg-green-500 transition-all duration-300" style="width: ${progress}%"></div>
              </div>
            </div>
            
            <div class="space-y-2">
              ${items.map(item => `
                <div onclick="toggleShoppingItem('${item.id}')"
                  class="rounded-xl p-4 cursor-pointer transition-all ${item.checked ? 'bg-green-50' : 'bg-gray-50'}">
                  <div class="flex items-start gap-3">
                    <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-0.5
                                ${item.checked ? 'checkbox-bought' : 'border-gray-300'}">
                      ${item.checked ? '<svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>' : ''}
                    </div>
                    <div class="flex-1">
                      <div class="font-medium ${item.checked ? 'line-through text-gray-400' : 'text-gray-900'}">${item.name}</div>
                      ${item.note ? `
                        <div class="text-sm mt-1 ${item.checked ? 'text-gray-400' : 'text-gray-600'}">
                          ${item.perDay && item.multiplier > 1 
                            ? `<span class="${item.checked ? '' : 'text-[#c41e3a] font-medium'}">${item.note} √ó ${item.multiplier} ng√†y</span>` 
                            : item.note}
                        </div>
                      ` : ''}
                      ${item.source ? `
                        <div class="text-xs mt-1 flex items-center gap-1 ${item.checked ? 'text-gray-400' : 'text-amber-600'}"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i> ${item.source}</div>
                      ` : ''}
                    </div>
                    <span class="text-xs text-gray-400 bg-gray-200 px-2 py-1 rounded-full">${item.days} ng√†y</span>
                  </div>
                </div>
              `).join('')}
            </div>
            
            <div class="mt-4 p-3 bg-amber-50 rounded-xl text-xs text-amber-700">
              <i data-lucide="info" class="w-4 h-4 inline-block align-text-bottom"></i> <strong>Ghi ch√∫:</strong> M√≥n c√≥ "√ó N ng√†y" c·∫ßn mua g·∫•p N l·∫ßn. M√≥n c√≥ <i data-lucide="map-pin" class="w-3 h-3 inline-block align-text-bottom"></i> l√† ng∆∞·ªùi kh√°c lo.
            </div>
          `}
        </div>
      `;
    }

    function renderPopup() {
      const container = document.getElementById('popup-container');
      
      if (state.showAddPopup) {
        container.innerHTML = renderAddPopup();
      } else if (state.showRecipe) {
        container.innerHTML = renderRecipePopup();
      } else {
        container.innerHTML = '';
      }
      lucide.createIcons();
    }

    function renderAddPopup() {
      const available = getAvailableDishes();
      const selectedCount = Object.values(state.addPopupSelections).filter(Boolean).length;
      
      return `
        <div class="fixed inset-0 bg-black/50 z-50" onclick="closeAddPopup()">
          <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[80vh] flex flex-col slide-up max-w-md mx-auto"
               onclick="event.stopPropagation()">
            
            <div class="p-4 border-b flex items-center justify-between flex-shrink-0">
              <div>
                <h3 class="font-bold text-lg">Th√™m m√≥n v√†o M√πng ${state.activeDay}</h3>
                <p class="text-sm text-gray-500">${available.length} m√≥n c√≥ s·∫µn</p>
              </div>
              <button onclick="closeAddPopup()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">
                <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
              </button>
            </div>
            
            <div class="flex-1 overflow-auto p-4">
              <div class="space-y-2">
                ${available.map(dish => `
                  <label id="label-${dish.id}" 
                    class="flex items-center gap-3 p-3 rounded-xl cursor-pointer ${state.addPopupSelections[dish.id] ? 'bg-red-50 border-2 border-[#c41e3a]' : 'bg-gray-50 border-2 border-transparent'}">
                    <input type="checkbox" id="cb-${dish.id}"
                           ${state.addPopupSelections[dish.id] ? 'checked' : ''}
                           onchange="toggleAddSelection('${dish.id}')"
                           class="w-5 h-5 rounded">
                    <div class="flex-1">
                      <div class="font-medium text-gray-900">${dish.name}</div>
                      ${dish.note || dish.source ? `
                        <div class="text-xs text-gray-500 mt-0.5">
                          ${dish.note || ''}${dish.note && dish.source ? ' ‚Ä¢ ' : ''}${dish.source || ''}
                        </div>
                      ` : ''}
                    </div>
                    ${!dish.perDay ? '<span class="text-xs text-gray-400 bg-gray-200 px-2 py-0.5 rounded">D√πng chung</span>' : ''}
                  </label>
                `).join('')}
              </div>
            </div>
            
            <div class="p-4 border-t flex-shrink-0 safe-bottom">
              <button id="add-confirm-btn" onclick="confirmAddDishes()"
                ${selectedCount === 0 ? 'disabled' : ''}
                class="w-full py-3.5 bg-[#c41e3a] text-white rounded-xl font-medium
                       disabled:bg-gray-300 disabled:cursor-not-allowed transition-all">
                ${selectedCount > 0 ? `Th√™m ${selectedCount} m√≥n ƒë√£ ch·ªçn` : 'Ch·ªçn m√≥n ƒë·ªÉ th√™m'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderRecipePopup() {
      const dish = getDishById(state.showRecipe);
      const recipe = recipes[state.showRecipe];
      if (!recipe || !dish) return '';
      
      return `
        <div class="fixed inset-0 bg-black/50 z-50" onclick="closeRecipe()">
          <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl max-h-[85vh] flex flex-col slide-up max-w-md mx-auto"
               onclick="event.stopPropagation()">
            
            <div class="p-4 border-b flex-shrink-0">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-bold text-lg">${recipe.name}</h3>
                  <p class="text-sm text-gray-500">${recipe.servings} ‚Ä¢ ${recipe.time}</p>
                </div>
                <button onclick="closeRecipe()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">
                  <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
              </div>
            </div>
            
            <div class="flex-1 overflow-auto p-4 space-y-5">
              <div>
                <h4 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                  <span class="w-6 h-6 bg-amber-100 rounded-full flex items-center justify-center"><i data-lucide="leaf" class="w-3.5 h-3.5 text-amber-700"></i></span>
                  Nguy√™n li·ªáu
                </h4>
                <div class="bg-amber-50 rounded-xl p-3 space-y-1.5">
                  ${recipe.ingredients.map(ing => `
                    <div class="text-sm text-gray-700">‚Ä¢ ${ing}</div>
                  `).join('')}
                </div>
              </div>
              
              <div>
                <h4 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                  <span class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center"><i data-lucide="chef-hat" class="w-3.5 h-3.5 text-orange-700"></i></span>
                  C√°ch l√†m
                </h4>
                <div class="space-y-3">
                  ${recipe.steps.map((step, i) => `
                    <div class="flex gap-3">
                      <div class="w-6 h-6 bg-[#c41e3a] text-white rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                        ${i + 1}
                      </div>
                      <p class="text-sm text-gray-700 leading-relaxed">${step}</p>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
            
            <div class="p-4 border-t flex-shrink-0 safe-bottom">
              <button onclick="closeRecipe()"
                class="w-full py-3 bg-gray-100 text-gray-700 rounded-xl font-medium">
                ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ==================== INIT ====================
    window.setMainTab = setMainTab;
    window.setActiveDay = setActiveDay;
    window.toggleDone = toggleDone;
    window.removeDish = removeDish;
    window.toggleShoppingItem = toggleShoppingItem;
    window.openAddPopup = openAddPopup;
    window.closeAddPopup = closeAddPopup;
    window.toggleAddSelection = toggleAddSelection;
    window.confirmAddDishes = confirmAddDishes;
    window.openRecipe = openRecipe;
    window.closeRecipe = closeRecipe;

    loadState();
    renderMain();
    renderPopup();

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    // Install as App prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const banner = document.createElement('div');
      banner.id = 'installBanner';
      banner.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#c41e3a,#e74c3c);color:#fff;padding:1rem;display:flex;align-items:center;justify-content:center;gap:0.8rem;z-index:9999;box-shadow:0 -2px 12px rgba(0,0,0,0.15)';
      banner.innerHTML = `
        <span style="font-size:0.95rem"><i data-lucide="download" style="width:16px;height:16px;display:inline-block;vertical-align:text-bottom"></i> C√†i ƒë·∫∑t ·ª©ng d·ª•ng Th·ª±c ƒë∆°n T·∫øt!</span>
        <button id="installBtn" style="background:#ffe066;color:#4a2c2a;border:none;padding:0.6rem 1.4rem;border-radius:8px;font-weight:700;font-size:0.95rem;cursor:pointer">C√†i ƒë·∫∑t</button>
        <button id="installClose" style="background:none;border:none;color:#ffe066;font-size:1.4rem;cursor:pointer">&times;</button>
      `;
      document.body.appendChild(banner);
      lucide.createIcons();
      document.getElementById('installBtn').onclick = async () => {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        banner.remove();
      };
      document.getElementById('installClose').onclick = () => banner.remove();
    });

    window.addEventListener('appinstalled', () => {
      const b = document.getElementById('installBanner');
      if (b) b.remove();
    });
  </script>
</body>
</html>
